# λ¶„μ‚°λ½

Redisλ¥Ό μ‚¬μ©ν• λ¶„μ‚° λ½(Distributed Lock)μ€ μ—¬λ¬ μ„λ²„λ‚ ν”„λ΅μ„Έμ¤κ°€ κ³µμ λ μμ›μ— λ™μ‹μ— μ ‘κ·Όν•λ” κ²ƒμ„ μ μ–΄ν•κΈ° μ„ν• λ™κΈ°ν™” λ©”μ»¤λ‹μ¦μ΄λ‹¤.

λ¶„μ‚° ν™κ²½(μ: μ—¬λ¬ λ€μ μ›Ή μ„λ²„κ°€ ν•λ‚μ λ°μ΄ν„°λ² μ΄μ¤μ— μ ‘κ·Ό)μ—μ„λ” μΌλ°μ μΈ ν”„λ΅κ·Έλλ° μ–Έμ–΄μ λ½(lock)μΌλ΅λ” λ™μ‹μ„±μ„ μ μ–΄ν•  μ μ—†λ‹¤.  μ΄λ•, λ¨λ“  μ„λ²„κ°€ κ³µν†µμΌλ΅ μ ‘κ·Όν•  μ μλ” Redisμ™€ κ°™μ€ μ™Έλ¶€ μ‹μ¤ν…μ„ μ‚¬μ©ν•΄ 'μ κΈ' μƒνƒλ¥Ό κ³µμ ν•λ‹¤. (μ¦‰, μ¬κ³  κ°μ†, μΏ ν° λ°κΈ‰, ν¬μΈνΈ μ§€κΈ‰ λ“± μ—¬λ¬ μ”μ²­μ΄ λ™μ‹μ— λ“¤μ–΄μ¤λ” κ²½μ°λ¥Ό λ¶„μ‚°λ½ λ©”μ»¤λ‹μ¦μΌλ΅ μ²λ¦¬ν•¨)


## Redis λ¶„μ‚° λ½μ ν•µμ‹¬ μ›λ¦¬

https://careers.saigontechnology.com/blog-detail/implement-distributed-lock-for-a-microservices-software-system

Redis λ¶„μ‚° λ½μ κΈ°λ³Έ μ•„μ΄λ””μ–΄λ” κ°„λ‹¨ν•¨.

1. **λ½ νλ“ (Acquire):** κ³µμ  μμ›μ— μ ‘κ·Όν•λ ¤λ” ν”„λ΅μ„Έμ¤κ°€ Redisμ— μ •ν•΄μ§„ 'ν‚¤(key)'λ¥Ό μƒμ„±ν•λ ¤κ³  μ‹λ„ν•¨.
2. **ν‚¤ μ΅΄μ¬ ν™•μΈ:**
    - **μ„±κ³µ (ν‚¤ μƒμ„±):** ν‚¤κ°€ μ„±κ³µμ μΌλ΅ μƒμ„±λλ©΄ 'λ½μ„ νλ“'ν• κ²ƒμΌλ΅ κ°„μ£Όν•κ³ , ν•΄λ‹Ή ν”„λ΅μ„Έμ¤κ°€ μ„κ³„ μμ—­(Critical Section)μ μ‘μ—…μ„ μν–‰ν•¨.
    - **μ‹¤ν¨ (ν‚¤ μ΄λ―Έ μ΅΄μ¬):** ν‚¤κ°€ μ΄λ―Έ μ΅΄μ¬ν•λ‹¤λ©΄ λ‹¤λ¥Έ ν”„λ΅μ„Έμ¤κ°€ λ½μ„ μ μ  μ¤‘μΈ κ²ƒμ…λ‹λ‹¤. λ½μ„ νλ“ν•  λ•κΉμ§€ λ€κΈ°ν•κ±°λ‚(Spinlock) ν¬κΈ°ν•¨.
3. **λ½ ν•΄μ  (Release):** μ‘μ—…μ΄ μ™„λ£λλ©΄ Redisμ—μ„ ν•΄λ‹Ή ν‚¤λ¥Ό μ‚­μ ν•μ—¬ λ‹¤λ¥Έ ν”„λ΅μ„Έμ¤κ°€ λ½μ„ νλ“ν•  μ μλ„λ΅ ν•¨.

![λ¶„μ‚°λ½ κµ¬μ΅° λ‹¤μ΄μ–΄κ·Έλ¨](./img/λ¶„μ‚°λ½κµ¬μ΅°λ‹¤μ΄μ–΄κ·Έλ¨.png)


λ¶„μ‚° μ κΈ κ΄€λ¦¬μ (DML) : λ¶„μ‚° μ‹μ¤ν…μ—μ„ μ—¬λ¬ ν΄λΌμ΄μ–ΈνΈκ°€ μ•΅μ„Έμ¤ν•  μ μλ” μ κΈμ„ κ΄€λ¦¬ν•λ” μ†ν”„νΈμ›¨μ–΄ κµ¬μ„± μ”μ† (λ…Όλ¦¬μ  κ°λ…μ΄λ©°, μ—¬κΈ°μ„ Redisκ°€ μ΄ μ—­ν• μ„ ν•¨)


## **λ λ“λ½ μ•κ³ λ¦¬μ¦ (The Redlock Algorithm)**

https://redis.io/docs/latest/develop/clients/patterns/distributed-locks/#the-redlock-algorithm

: Redisμ λ¶„μ‚°λ½ μ•κ³ λ¦¬μ¦.

### **μµμ†ν• μ¶©μ΅±**ν•΄μ•Ό ν•  μ„Έ κ°€μ§€ μ†μ„±

1. **Safety property**: μƒνΈ λ°°μ μ„±(Mutual exclusion)
    
    : μ¤μ§ ν•λ‚μ ν΄λΌμ΄μ–ΈνΈ(μ„λ²„ μΈμ¤ν„΄μ¤)λ§μ΄ νΉμ • κ³µμ  μμ›μ— λ€ν• λ½μ„ νλ“ν•  μ μμ–΄μ•Ό ν•¨
    
2. **Liveness property A:** λ°λ“λ½ λ°©μ§€(Deadlock free)
    
    : λ½μ„ νλ“ν• ν΄λΌμ΄μ–ΈνΈκ°€ μ¶©λ λ“±μ λ¬Έμ λ΅ μΈν•΄ λ½μ„ ν•΄μ ν•μ§€ λ»ν•λ”λΌλ„ λ‹¤λ¥Έ ν΄λΌμ΄μ–ΈνΈκ°€ λ½μ„ νλ“ν•  μ μμ–΄μ•Ό ν•¨
    
3. **Liveness property B**: κ²°ν•¨ ν—μ©(Fault tolerance)
    
    : λ½ κ΄€λ¦¬ μ‹μ¤ν…(μ—¬κΈ°μ„λ” Redis)μ— **μΌλ¶€ λ…Έλ“μ μ¥μ• **κ°€ λ°μƒν•λ”λΌλ„, μ‹μ¤ν…μ κ³Όλ°μ(Majority)κ°€ μ •μƒ μ‘λ™ν•λ” ν• ν΄λΌμ΄μ–ΈνΈλ“¤μ€ μ—¬μ „ν λ½μ„ νλ“ν•κ³  ν•΄μ ν•  μ μμ–΄μ•Ό ν•¨
    

![λ¶„μ‚° μ‹μ¤ν… κµμ°© μƒνƒ](./img/λ¶„μ‚°μ‹μ¤ν…κµμ°©μƒνƒ.png)

<aside>
π’΅

β‡’ μ΄λ¬ν• μ„Έ κ°€μ§€ μ†μ„±μ„ λ¨λ‘ μ¶©μ΅±μ‹ν‚¤κΈ° μ„ν•μ—¬ λ λ””μ¤μ—μ„ β€λ λ“λ½ μ•κ³ λ¦¬μ¦β€™μ„ μ μ‹ν•λ‹¤.

(νΉν, 

**λ°λ“λ½ λ°©μ§€**: μµμ…κ³Ό μ§§μ€ νƒ€μ„μ•„μ›ƒμ„ ν†µν•΄ λ…Έλ“ μ¥μ•  μ‹μ—λ„ μκµ¬μ μΈ λ½μ„ λ°©μ§€ν•¨.

**κ²°ν•¨ ν—μ©**: *N* κ° μ¤‘ κ³Όλ°μ *(N/2 + 1)* λ§ μ„±κ³µν•λ©΄ λ½μ„ μΈμ •ν•¨μΌλ΅μ¨, **μΌλ¶€ λ…Έλ“μ— μ¥μ• **κ°€ λ°μƒν•λ”λΌλ„ μ „μ²΄ λ½ μ‹μ¤ν…μ΄ λ©μ¶”μ§€ μ•κ³  κ³„μ† μ‘λ™ν•  μ μλ„λ΅ ν•¨. 

μ„ μ„ν•μ—¬. )

</aside>

### μ „μ  μ΅°κ±΄

- Nκ°μ **λ…λ¦½μ μΈ** Redis λ§μ¤ν„° λ…Έλ“
- **λ‹¨μΌ μΈμ¤ν„΄μ¤** μ‚¬μ© κµ¬ν„
    1. μ κΈ(Lock) νλ“: 
    
     `SET resource_name my_random_value NX PX 30000`
        - SET resource_name : ν‚¤ κ°’ μ„¤μ •
        - my_random_value : λ½μ„ νλ“ν• ν΄λΌμ΄μ–ΈνΈμ κ³ μ  μ‹λ³„μ
        - NX : μ΄ ν‚¤κ°€ μ•„μ§ Redisμ— μ΅΄μ¬ν•μ§€ μ•μ„ λ•λ§ κ°’ μ„¤μ •ν•¨
            
            (ν‚¤κ°€ μ΄λ―Έ μμΌλ©΄ λ½ νλ“ μ‹¤ν¨ β†’ μƒνΈλ°°μ  λ³΄μ¥)
            
        - PX 30000: ν‚¤μ λ§λ£μ‹κ°„ 30,000λ°€λ¦¬μ΄ (30μ΄) μ„¤μ •ν•¨
            
            (λ½μ„ μμ›ν ν•΄μ ν•μ§€ λ»ν•λ” λ°λ“λ½ λ°©μ§€)
            
    2. μ κΈ(Lock) ν•΄μ : 
    
    ```lua
    if redis.call("get",KEYS[1]) == ARGV[1] then
        return redis.call("del",KEYS[1])
    else
        return 0
    end
    ```
    
- redis.call("get", KEYS[1]) == ARGV[1]: 
ν„μ¬ λ½ ν‚¤(`KEYS[1]`, μ¦‰ `resource_name`)μ— μ €μ¥λ κ°’μ΄ **μ΄ ν΄λΌμ΄μ–ΈνΈκ°€ μ„¤μ •ν–λ κ³ μ  κ°’**(`ARGV[1]`, μ¦‰ `my_random_value`)κ³Ό μΌμΉν•λ”μ§€ ν™•μΈν•¨.
- redis.call("del", KEYS[1]):
κ°’μ΄ μΌμΉν•λ©΄ (λ‚΄κ°€ μ„¤μ •ν• λ½μ΄ λ§μΌλ©΄) ν‚¤λ¥Ό **μ‚­μ ν•¨**.
- else return 0:
    
    κ°’μ΄ μΌμΉν•μ§€ μ•μΌλ©΄ (λ‹¤λ¥Έ ν΄λΌμ΄μ–ΈνΈκ°€ λ½μ„ μ¬νλ“ν–κ±°λ‚ λ½μ΄ λ§λ£λ κ²½μ°) μ•„λ¬΄κ²ƒλ„ ν•μ§€ μ•κ³  0μ„ λ°ν™ν•¨. 
    
    (λ‹¤λ¥Έ ν΄λΌμ΄μ–ΈνΈμ λ½μ„ μ‹¤μλ΅ μ‚­μ ν•λ” κ²ƒ λ°©μ§€)
    

### **λ½ νλ“ & ν•΄μ  κ³Όμ •**

**1. μ‹κ° κΈ°λ΅**: λ½ νλ“μ„ μ‹μ‘ν• ν„μ¬ μ‹κ° *T_{start}* μ„ λ°€λ¦¬μ΄ λ‹¨μ„λ΅ κΈ°λ΅ν•¨.

**2. λ³‘λ ¬ μ”μ²­**: *N*κ°μ λ¨λ“  Redis λ§μ¤ν„°μ— **λ™μΌν• ν‚¤, λ™μΌν• λλ¤ κ°’, λ™μΌν• TTL**λ΅ λ½ νλ“(`SET ... NX PX TTL`)μ„ **λ³‘λ ¬**λ΅ μ‹λ„ν•¨. μ΄λ• κ° μΈμ¤ν„΄μ¤μ™€μ ν†µμ‹  νƒ€μ„μ•„μ›ƒμ€ **TTLλ³΄λ‹¤ ν›¨μ”¬ μ§§κ²** μ„¤μ •ν•¨.

**3. μ„±κ³µ μ΅°κ±΄ ν™•μΈ**: λ‹¤μ λ‘ μ΅°κ±΄μ„ λ¨λ‘ μ¶©μ΅±ν•΄μ•Ό λ½ νλ“μ΄ **μ„±κ³µ**μΌλ΅ κ°„μ£Όλ¨.

- **κ³Όλ°μ νλ“**: *N/2 + 1* (μ¦‰, 3κ° μ΄μƒ)μ μΈμ¤ν„΄μ¤μ—μ„ λ½μ„ νλ“ν•΄μ•Ό ν•¨.
- **μ‹κ°„ μ ν¨μ„±**: λ½ νλ“μ— μ†μ”λ μ΄ κ²½κ³Ό μ‹κ°„ *T_{elapsed}* = *T_{end}* - *T_{start}* μ΄ μµμ΄ μ„¤μ •ν• **TTLλ³΄λ‹¤ μ§§μ•„μ•Ό** ν•¨.

**4. μ ν¨ μ‹κ°„ μ¬κ³„μ‚°**: λ½ νλ“μ— μ„±κ³µν•λ©΄, μ‹¤μ  μ ν¨ μ‹κ°„μ€ *TTL - T_{elapsed} - Clock_Drift* λ΅ μ¬κ³„μ‚°λ¨.

**5. μ‹¤ν¨ μ‹ ν•΄μ **: λ½ νλ“μ— μ‹¤ν¨ν•λ©΄ (κ³Όλ°μ λ―Έλ‹¬ λλ” μ ν¨ μ‹κ°„ μ΄κ³Ό), **λ¶€λ¶„μ μΌλ΅ λ½μ΄ κ±Έλ¦° λ¨λ“  μΈμ¤ν„΄μ¤**μ— λ½ ν•΄μ (`DEL`) λ…λ Ήμ„ μ¦‰μ‹ λ³΄λƒ„.

- **μ•μ „ μ†μ„± (Safety Arguments)**
Redlockμ μ•μ „μ„±(μƒνΈ λ°°μ )μ€ λ‹¤μ μ›λ¦¬λ΅ λ³΄μ¥λ¨:
β€Ά **κ³Όλ°μ μ›μΉ™**: λ½μ΄ κ³Όλ°μ *(N/2 + 1)* μ λ…Έλ“μ— μ„¤μ •λμ–΄ μλ” λ™μ•μ—λ”, λ‹¤λ¥Έ μ–΄λ–¤ ν΄λΌμ΄μ–ΈνΈλ„ **λ™μ‹μ—** κ³Όλ°μ λ½μ„ νλ“ν•  μ μ—†λ‹¤. (μ΄λ―Έ *(N/2 + 1)* κ°μ ν‚¤κ°€ μ΅΄μ¬ν•κΈ° λ•λ¬Έ)
β€Ά **μ‹κ°„ μ ν•**: ν΄λΌμ΄μ–ΈνΈκ°€ λ½μ„ νλ“ν•λ” λ° λ„λ¬΄ μ¤λ μ‹κ°„μ΄ κ±Έλ ¤ *TTL*μ„ μ΄κ³Όν•λ©΄, κ·Έ λ½μ€ μ¦‰μ‹ **λ¬΄ν¨**λ΅ κ°„μ£Όλμ–΄ ν•΄μ λλ―€λ΅, λ™μ‹μ— λ½μ΄ νλ“λλ” μƒν™©μ„ λ°©μ§€ν•λ‹¤.
β€Ά **μ ν¨μ„± λ³΄μ¦**: λ½μ μµμ† μ ν¨ μ‹κ°„ *MIN_VALIDITY* μ€ *[TTL - (T_{2}-T_{1}) - CLOCK_DRIFT]* λ΅ λ³΄μ¥λλ‹¤.
- **ν™μ„± μ†μ„± (Liveness Arguments)**
μ‹μ¤ν…μ μ¤‘λ‹¨ μ—†μ΄ κ³„μ† μ‘λ™ν•λ” λ¥λ ¥μ€ λ‹¤μκ³Ό κ°™μ΄ λ³΄μ¥λ¨:
β€Ά **μλ™ ν•΄μ **: λ¨λ“  ν‚¤μ— **TTL**μ΄ μ„¤μ •λμ–΄ μμΌλ―€λ΅, λ½μ„ ν•΄μ ν•μ§€ λ»ν• ν΄λΌμ΄μ–ΈνΈκ°€ μλ”λΌλ„ κ²°κµ­ μ‹κ°„μ΄ μ§€λ‚λ©΄ λ½μ΄ μλ™ ν•΄μ λλ‹¤. (**λ°λ“λ½ λ°©μ§€**)
β€Ά **ν‘λ ¥μ  ν•΄μ **: λ½ νλ“μ— μ‹¤ν¨ν• ν΄λΌμ΄μ–ΈνΈκ°€ **ASAP(κ°€λ¥ν• ν• λΉ¨λ¦¬)** λ¶€λ¶„μ μΌλ΅ κ±Έλ¦° λ½μ„ ν•΄μ ν•λ„λ΅ μ”κµ¬ν•μ—¬, λ‹¤λ¥Έ ν΄λΌμ΄μ–ΈνΈκ°€ λ½μ„ κΈ°λ‹¤λ¦¬λ” μ‹κ°„μ„ μ¤„μΈλ‹¤.
β€Ά **μ¬μ‹λ„ μ§€μ—°**: λ½ νλ“μ— μ‹¤ν¨ν• ν΄λΌμ΄μ–ΈνΈλ” **λλ¤ν• μ§€μ—° μ‹κ°„**μ„ λ‘κ³  μ¬μ‹λ„ν•μ—¬, μ—¬λ¬ ν΄λΌμ΄μ–ΈνΈκ°€ λ™μ‹μ— λ½μ„ μ‹λ„ν•λ©° μ¶©λν•λ” μƒν™©(μ¤ν”λ¦Ώ λΈλ μΈ)μ„ ν™•λ¥ μ μΌλ΅ λ‚®μ¶λ‹¤.

![RedLock μ•κ³ λ¦¬μ¦ λ‹¤μ΄μ–΄κ·Έλ¨](./img/λ λ“λ½μ•κ³ λ¦¬μ¦λ‹¤μ΄μ–΄κ·Έλ¨.png)



